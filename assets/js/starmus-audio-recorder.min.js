document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelector("[data-enabled-recorder]");if(!e)return;const t=document.getElementById("sparxstar_recordButton")||document.getElementById("recordButton"),a=document.getElementById("sparxstar_pauseButton")||document.getElementById("pauseButton"),n=document.getElementById("sparxstar_playButton")||document.getElementById("playButton"),o=document.getElementById("sparxstar_timer")||document.getElementById("timer"),r=document.getElementById("sparxstar_audioPlayer")||document.getElementById("audioPlayer"),i=e.querySelector('input[type="file"][accept*="audio"]'),d=e.querySelector('input[name="audio_uuid"]'),s=e.querySelector("#sparxstar_audioLevelBar"),c=12e5;if(!(t&&a&&n&&o&&r))return;let u,l,p,m,f,y,g,x,w=[],R=null,h=!1,b=!1,v=0;function animateBar(){if(f&&y&&s&&h&&!b){f.getByteFrequencyData(y);const e=y.reduce(((e,t)=>e+t),0)/y.length,t=Math.min(e/255*100,100);s.style.width=`${t}%`,s.setAttribute("aria-valuenow",Math.round(t)),x=requestAnimationFrame(animateBar)}else stopAnimationBarLoop()}function stopAnimationBarLoop(){x&&(cancelAnimationFrame(x),x=null),s&&(s.style.width="0%")}function formatTime(e){const t=Math.floor(e/1e3),a=Math.floor(t/60),n=t%60;return`${String(a).padStart(2,"0")}:${String(n).padStart(2,"0")}`}function updateTimerColor(e){o.classList.remove("red","orange"),o.style.color="",e<=12e4?o.classList.add("red"):e<=42e4&&o.classList.add("orange")}function updateTimerDisplay(){let e=0;h&&!b&&(e=Date.now()-p);const t=v+e,a=Math.max(0,c-t);o.textContent=formatTime(a),updateTimerColor(a),a<=0&&stopRecording()}function stopTimerAndResetDisplay(){clearInterval(l),l=null,v=0,o.textContent=formatTime(c),updateTimerColor(c)}function updateStatus(e){const t=document.getElementById("sparxstar_status");t&&(t.textContent=e)}function handleRecordingReady(){t.disabled=!1,a.disabled=!0,a.textContent="Pause",n.disabled=!r.src||r.src===window.location.href}function handleDataAvailable(e){e.data.size>0&&w.push(e.data)}function handleStop(){if(stopAnimationBarLoop(),clearInterval(l),h&&!b&&(v+=Date.now()-p),!u||0===w.length)return w=[],stopTimerAndResetDisplay(),h=!1,b=!1,t.textContent="Record",t.setAttribute("aria-pressed","false"),updateStatus("Recording stopped, no audio captured."),handleRecordingReady(),void(R&&(R.getTracks().forEach((e=>e.stop())),R=null));const e=u.mimeType;let a;if(e.includes("opus")||e.includes("webm"))a="webm";else{if(!e.includes("aac"))return alert("Recording failed: unsupported audio format. Try a different browser."),w=[],stopTimerAndResetDisplay(),h=!1,b=!1,t.textContent="Record",handleRecordingReady(),void(R&&(R.getTracks().forEach((e=>e.stop())),R=null));a="m4a"}const n=new Blob(w,{type:e}),o=URL.createObjectURL(n);r.src=o,function attachAudioToForm(e,t){const a=`audio_${function generateUUID(){try{if("undefined"!=typeof crypto&&"function"==typeof crypto.randomUUID)return crypto.randomUUID();if("undefined"!=typeof crypto&&"function"==typeof crypto.getRandomValues){const e=new Uint8Array(16);crypto.getRandomValues(e),e[6]=15&e[6]|64,e[8]=63&e[8]|128;const U=t=>e[t].toString(16).padStart(2,"0");return`${U(0)}${U(1)}${U(2)}${U(3)}-${U(4)}${U(5)}-${U(6)}${U(7)}-${U(8)}${U(9)}-${U(10)}${U(11)}${U(12)}${U(13)}${U(14)}${U(15)}`}}catch(t){}let e=(new Date).getTime();"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=performance.now());return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const a=(e+16*Math.random())%16|0;return e=Math.floor(e/16),("x"===t?a:3&a|8).toString(16)}))}()}.${t}`;d&&(d.value=a);const n=new File([e],a,{type:e.type});if(!i)return;const o=new DataTransfer;o.items.add(n),i.files=o.files,updateStatus("Recording saved.")}(n,a),w=[],stopTimerAndResetDisplay(),h=!1,b=!1,t.textContent="Record",handleRecordingReady(),R&&(R.getTracks().forEach((e=>e.stop())),R=null)}async function startRecording(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia||!window.MediaRecorder)return void alert("Audio recording is not fully supported in your browser.");let e=["audio/webm;codecs=opus","audio/mp4;codecs=aac","audio/webm"].find((e=>MediaRecorder.isTypeSupported(e)));if(e)try{const o=await navigator.mediaDevices.getUserMedia({audio:!0});R=o,w=[],u=new MediaRecorder(o,{mimeType:e}),u.ondataavailable=handleDataAvailable,u.onstop=handleStop,u.start(),h=!0,b=!1,t.textContent="Stop",t.setAttribute("aria-pressed",h),a.disabled=!1,a.textContent="Pause",n.disabled=!0,updateStatus("Recording started…"),r.src="",function startTimerForNewRecording(){v=0,p=Date.now(),l&&clearInterval(l),l=setInterval(updateTimerDisplay,1e3),updateTimerDisplay()}(),s&&(window.AudioContext||window.webkitAudioContext)&&(m&&m.close(),m=new(window.AudioContext||window.webkitAudioContext),f=m.createAnalyser(),f.fftSize=256,y=new Uint8Array(f.frequencyBinCount),g=m.createMediaStreamSource(o),g.connect(f),animateBar())}catch(o){let e="Failed to access microphone or start recording.";"NotAllowedError"===o.name||"PermissionDeniedError"===o.name?e="Microphone access denied. Please allow in browser settings.":"NotFoundError"===o.name||"DevicesNotFoundError"===o.name?e="No microphone found. Please connect one.":"NotReadableError"!==o.name&&"TrackStartError"!==o.name||(e="Microphone in use or unreadable. Check other apps."),alert(e),h=!1,b=!1,t.textContent="Record",handleRecordingReady(),stopTimerAndResetDisplay()}else alert("No suitable audio recording format supported. Please try a different browser.")}function stopRecording(){h&&u&&"inactive"!==u.state?u.stop():h&&handleStop()}o.setAttribute("aria-live","polite"),t.addEventListener("click",(()=>{h?stopRecording():startRecording()})),a.addEventListener("click",(()=>{h&&(b?(u&&"paused"===u.state&&u.resume(),b=!1,function resumeTimer(){p=Date.now(),l&&clearInterval(l),l=setInterval(updateTimerDisplay,1e3),updateTimerDisplay()}(),f&&animateBar(),a.textContent="Pause",a.setAttribute("aria-pressed",b),updateStatus("Recording started…")):(u&&"recording"===u.state&&u.pause(),function pauseTimer(){clearInterval(l),l=null,h&&(v+=Date.now()-p),updateTimerDisplay()}(),b=!0,stopAnimationBarLoop(),a.textContent="Resume",a.setAttribute("aria-pressed",b),updateStatus("Recording paused")))})),n.addEventListener("click",(()=>{r.src&&r.src!==window.location.href&&r.play()})),async function setupRecorder(){if(t.disabled=!0,a.disabled=!0,n.disabled=!0,navigator.permissions&&navigator.permissions.query)try{const e=await navigator.permissions.query({name:"microphone"}),updateButtonOnPermission=()=>{"granted"===e.state||"prompt"===e.state?t.disabled=!1:(t.disabled=!0,alert("Microphone access denied. Enable in browser settings to record."))};updateButtonOnPermission(),e.onchange=updateButtonOnPermission}catch(e){t.disabled=!1}else t.disabled=!1;o.textContent=formatTime(c),updateTimerColor(c)}()}));
//# sourceMappingURL=starmus-audio-recorder.min.js.map