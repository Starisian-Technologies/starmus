document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("recordButton"),t=document.getElementById("pauseButton"),o=document.getElementById("playButton"),r=document.getElementById("timer"),n=document.getElementById("audioPlayer"),a="field_audio_attachment",i=12e5;if(!(e&&t&&o&&r&&n))return;let d,s,c,l=[],u=!1,p=!1;function updateTimerDisplay(){const e=Date.now()-s,t=Math.max(0,i-e),o=Math.floor(t/6e4),n=Math.floor(t%6e4/1e3),a=`${String(o).padStart(2,"0")}:${String(n).padStart(2,"0")}`;r.textContent=a,function updateTimerColor(e){r.style.color=e<=12e4?"red":e<=42e4?"orange":""}(t),t<=0&&stopRecording()}function startTimer(){s=Date.now(),c=setInterval(updateTimerDisplay,1e3)}function stopTimer(){clearInterval(c)}function handleRecordingReady(){e.disabled=!1,t.disabled=!0,o.disabled=!n.src||n.src===window.location.href}function handleDataAvailable(e){e.data.size>0&&l.push(e.data)}function handleStop(){if(!d||0===l.length)return l=[],stopTimer(),r.textContent="00:00",r.style.color="",u=!1,p=!1,e.textContent="Record",void handleRecordingReady();let t,o;const i=d.mimeType;if(i.includes("opus"))t=new Blob(l,{type:i}),o="webm";else if(i.includes("aac"))t=new Blob(l,{type:i}),o="m4a";else{if(!i.includes("webm"))return void alert("Recording failed: The recorded audio format is not supported for processing. Please try a different browser.");t=new Blob(l,{type:i}),o="webm"}const s=URL.createObjectURL(t);n.src=s,function attachAudioToForm(e,t){const o=new File([e],`oral_history_recording.${t}`,{type:e.type}),r=new DataTransfer;r.items.add(o);const n=document.getElementById(a);n?n.files=r.files:alert(`Developer error: Form field with ID '${a}' not found. Please contact the site administrator.`)}(t,o),l=[],stopTimer(),r.textContent="00:00",r.style.color="",u=!1,p=!1,e.textContent="Record",handleRecordingReady()}function stopRecording(){u&&d&&"inactive"!==d.state?d.stop():u&&handleStop()}e.addEventListener("click",(()=>{u?stopRecording():async function startRecording(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void alert("Audio recording is not supported in your browser. Please use a modern browser that supports audio recording.");if(!window.MediaRecorder)return void alert("MediaRecorder is not supported in your browser. Please use a modern browser that supports MediaRecorder.");const r=document.getElementById("field_consent");if(!r)return void alert("Consent checkbox is missing. Please contact the administrator.");if(!r.checked)return void alert("Please provide your consent before recording.");const a=["audio/webm;codecs=opus","audio/mp4;codecs=aac","audio/webm"];let i=null;for(const e of a)if(MediaRecorder.isTypeSupported(e)){i=e;break}if(i)try{const r=await navigator.mediaDevices.getUserMedia({audio:!0});l=[],d=new MediaRecorder(r,{mimeType:i}),d.ondataavailable=handleDataAvailable,d.onstop=handleStop,d.start(),u=!0,p=!1,e.textContent="Stop",t.disabled=!1,o.disabled=!0,n.src="",startTimer(),updateTimerDisplay()}catch(s){let e="Failed to access the microphone or start recording. Please ensure it is enabled and not in use by another application.";"NotAllowedError"===s.name||"PermissionDeniedError"===s.name?e="Microphone access was denied. Please allow microphone access in your browser settings to record audio.":"NotFoundError"===s.name||"DevicesNotFoundError"===s.name?e="No microphone found. Please ensure a microphone is connected and enabled.":"NotReadableError"!==s.name&&"TrackStartError"!==s.name||(e="The microphone is currently in use or could not be accessed. Please ensure it is not being used by another application and is working correctly."),alert(e)}else alert("Your browser does not support any suitable audio recording format (e.g., WebM Opus, MP4 AAC). Please try a different browser.")}()})),t.addEventListener("click",(()=>{u&&!p?(d.pause(),p=!0,stopTimer(),e.textContent="Resume"):u&&p&&(d.resume(),p=!1,startTimer(),e.textContent="Stop")})),o.addEventListener("click",(()=>{n.play()})),async function setupRecorder(){if(t.disabled=!0,o.disabled=!0,e.disabled=!0,navigator.permissions&&navigator.permissions.query)try{const t=await navigator.permissions.query({name:"microphone"}),updateButtonBasedOnPermission=()=>{"granted"===t.state||"prompt"===t.state?e.disabled=!1:(e.disabled=!0,alert("Microphone access is denied. Please enable it in your browser settings to record audio."))};updateButtonBasedOnPermission(),t.onchange=updateButtonBasedOnPermission}catch(r){e.disabled=!1}else e.disabled=!1}()}));
//# sourceMappingURL=starmus-audio-recorder.min.js.map
